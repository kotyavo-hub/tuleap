include ../.env
export

DHOST := $(shell docker run --rm bash -c 'ip -4 route show default | cut -d" " -f3')
PWD   := $(shell pwd)

.PHONY: dump-redmine-db
dump-redmine-db:
	test -n "$(to)"
	ssh root@redmine.maximaster.ru "mysqldump -q redmine_new" > $(to)

.PHONY: dump-tuleap-db
dump-tuleap-db:
	test -n "$(to)"
	cd ../ && docker-compose exec db mysqldump -q -uroot -p$(MYSQL_ROOT_PASSWORD) tuleap 2>/dev/null > $(PWD)/$(to)
	sed -i '1d' $(to)

.PHONY: prepare
prepare:
	docker-compose run --rm app composer install

.PHONY: update
update:
	docker-compose run --rm app composer update

.PHONY: transfer
transfer:
	DHOST=$(DHOST) docker-compose run --rm app php ./bin/transfer.php $(with)
